rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['admin']);
    }

    function isCommunityManager() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['community-manager']);
    }

    function isFounderOf(communityId) {
        return isAuth() && get(/databases/$(database)/documents/communities/$(communityId)).data.founderUid == request.auth.uid;
    }

    function isAffiliatedWith(businessId) {
        return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.affiliation.orgId == businessId;
    }
    
    // Public read access for all images
    match /{folder}/{allPaths=**} {
      allow read;
    }

    // Write rules for specific folders
    match /profile-pictures/{userId}/{fileName} {
      allow write: if isOwner(userId) && request.resource.size < 10 * 1024 * 1024 && request.resource.contentType.matches('image/.*');
    }

    match /community-logos/{communityId}/{fileName} {
      allow write: if (isFounderOf(communityId) || isAdmin()) && request.resource.size < 10 * 1024 * 1024 && request.resource.contentType.matches('image/.*');
    }

    match /community-banners/{communityId}/{fileName} {
      allow write: if (isFounderOf(communityId) || isAdmin()) && request.resource.size < 10 * 1024 * 1024 && request.resource.contentType.matches('image/.*');
    }
    
    match /deal-images/{fileName} {
      allow write: if (isCommunityManager() || isAdmin()) && request.resource.size < 10 * 1024 * 1024 && request.resource.contentType.matches('image/.*');
    }

    match /event-banners/{fileName} {
        allow write: if (isCommunityManager() || isAdmin()) && request.resource.size < 10 * 1024 * 1024 && request.resource.contentType.matches('image/.*');
    }
    
    match /sponsor-logos/{fileName} {
      allow write: if isAdmin() && request.resource.size < 10 * 1024 * 1024 && request.resource.contentType.matches('image/.*');
    }
    
    match /branding/{fileName} {
      allow write: if isAdmin() && request.resource.size < 10 * 1024 * 1024 && request.resource.contentType.matches('image/.*');
    }

    match /team-avatars/{fileName} {
      allow write: if isAdmin() && request.resource.size < 10 * 1024 * 1024 && request.resource.contentType.matches('image/.*');
    }

     match /business-images/{fileName} {
      allow write: if isAdmin() && request.resource.size < 10 * 1024 * 1024 && request.resource.contentType.matches('image/.*');
    }
  }
}
