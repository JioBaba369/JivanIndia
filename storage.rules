rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Helper functions
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isCommunityFounder(communityId) {
       return get(/databases/$(database)/documents/communities/$(communityId)).data.founderUid == request.auth.uid;
    }

    // Allow public read access to all files.
    match /{allPaths=**} {
      allow read: if true;
    }

    // Users can only write to their own profile picture folder.
    // Limit file size to 5MB.
    match /profile-pictures/{userId}/{fileName} {
      allow write: if isOwner(userId) && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }

    // Users can only upload community logos/banners if they are the community founder.
    // Limit file size to 5MB.
    match /community-logos/{communityId}/{fileName} {
      allow write: if isCommunityFounder(communityId) && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }
    match /community-banners/{communityId}/{fileName} {
      allow write: if isCommunityFounder(communityId) && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }

    // Users can only upload event banners if they are the founder of the organizing community.
    // Limit file size to 5MB.
    // Note: This requires the event document to exist first or a more complex setup.
    // For simplicity, we can check affiliation. A better approach might use custom claims.
    match /event-banners/{organizerId}/{fileName} {
       allow write: if isCommunityFounder(organizerId) && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }
    
    // Deals and other business-related images follow a similar pattern.
    match /deal-images/{organizerId}/{fileName} {
       allow write: if isCommunityFounder(organizerId) && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }
  }
}
